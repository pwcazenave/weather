<html>

<head>
  <meta name="viewport" content="initial-scale=1.0, width=device-width" />
  <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js" type="text/javascript" charset="utf-8"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js" type="text/javascript" charset="utf-8"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js" type="text/javascript" charset="utf-8"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js" type="text/javascript" charset="utf-8"></script>
  <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
</head>

<body style='margin: 0'>
  <div style="width: 100%; height: 100%" id="mapContainer"></div>

  <script>
    // Default to PML
    var lon = -4.147850827985379;
    var lat = 50.36607618658233;
    var x = document.getElementById("map");

    // Initialize the platform object:
    var platform = new H.service.Platform({
      'apikey': '{{ api_key }}'
    });

    // Obtain the default map types from the platform object
    var maptypes = platform.createDefaultLayers();

    // Initialize a map:
    var map = new H.Map(
      document.getElementById('mapContainer'),
      maptypes.raster.terrain.map,
      {
        zoom: 6,
        center: { lat: lat, lng: lon }
      }
    );
    window.addEventListener('resize', () => map.getViewPort().resize());

    // Add a default marker - we'll update if we get either of a valid user
    // location (inside the model domain) or a click/tap.
    var marker = new H.map.Marker({ lat: lat, lng: lon });
    map.addObject(marker);

    var mapEvents = new H.mapevents.MapEvents(map);
    map.addEventListener('tap', function (evt) {
      // Centre the map view on clicks
      var coord = map.screenToGeo(evt.currentPointer.viewportX,
            evt.currentPointer.viewportY);
      map.setCenter({lng: coord.lng, lat: coord.lat})
      marker.setGeometry({lng: coord.lng, lat: coord.lat})
    });

    var behavior = new H.mapevents.Behavior(mapEvents);
    var ui = H.ui.UI.createDefault(map, maptypes);

    function setupMap(pos) {
      var crd = pos.coords;
      // Only recentre the map if we're within the model bounds
      if ( {{ west }} < crd.longitude < {{ east }} && {{ south }} < crd.latitude < {{ north }}) {
        marker.setGeometry({lng: crd.longitude, lat: crd.latitude});
        map.setCenter({lng: crd.longitude, lat: crd.latitude});
      }
    }

    function animateFrames(frames) {
      var counter = 0;
      var overlay = new H.map.Overlay(
        new H.geo.Rect(
          {{ north }}, {{ west}},
          {{ south }}, {{ east }}
        ),
        frames[0],
        { volatility: true }  // the bitmap is frequently updated so mark as volatile
      );
      // add overlay to the map
      map.addObject(overlay);    
      // animate all the other frames
      setInterval(function() {
        counter = counter <= frames.length ? ++counter : 0;
        overlay.setBitmap(weatherFrames[counter]);
      }, 250);
    }
    // Get the frames into an array of URLs
    var weatherFrames = [];
    for (i = 1; i <= 24; i++) {
      weatherFrames.push("{{ url_for('get_weather_frame') }}" + i);
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(setupMap);
    } else {
      alert("Geolocation is not supported by this browser.");
    }

    animateFrames(weatherFrames);

  </script>
</body>

</html>
